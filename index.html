<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Price Animation</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000000;
        }

        #riveCanvas {
            width: 100%;
            height: auto;
            max-width: 500px;
            max-height: 582px;
            aspect-ratio: 500 / 582; /* Maintain the original aspect ratio */
        }
    </style>
</head>
<body>
    <canvas id="riveCanvas"></canvas>

    <script src="https://unpkg.com/@rive-app/canvas@latest"></script>
    <script>
        let riveInstance, priceInputs = [], btcPriceInputs = [], greenInput;

        // Function to fetch the past 24-hour Bitcoin prices (hourly data)
        async function fetchBitcoinHistoricalPrices() {
            const response = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=1');
            const data = await response.json();

            // Extract hourly prices (assuming data points are more frequent than hourly)
            const totalDataPoints = data.prices.length;
            const interval = Math.floor(totalDataPoints / 24);
            const hourlyPrices = data.prices
                .filter((_, index) => index % interval === 0)
                .slice(-24)  // Ensure we have exactly 24 data points
                .map(price => price[1]); // Extract the price values in USD

            return hourlyPrices;
        }

        // Function to normalize prices between 0 and 100%
        function normalizePrices(prices) {
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const range = maxPrice - minPrice;

            if (range === 0) return prices.map(() => 100); // Avoid division by zero

            return prices.map(price => ((price - minPrice) / range) * 100); // Normalize
        }

        // Function to fetch Bitcoin's current price in USD and split it into individual digits
        async function fetchCurrentBitcoinPrice() {
            const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
            const data = await response.json();
            const currentPrice = Math.floor(data.bitcoin.usd).toString(); // Get current price in USD as a string and round it down

            return currentPrice.split(''); // Return the digits of the price as an array
        }

        // Function to update the Rive inputs with the normalized historical prices
        async function updateHistoricalPrices() {
            const prices = await fetchBitcoinHistoricalPrices(); // Fetch historical Bitcoin prices
            const normalizedPrices = normalizePrices(prices); // Normalize the prices between 0 and 100%

            // Feed the normalized percentages into the respective Rive inputs
            for (let i = 0; i < priceInputs.length; i++) {
                if (priceInputs[i]) {
                    priceInputs[i].value = normalizedPrices[i]; // Set the value of each input to the normalized price
                }
            }

            // Check if the most recent price is higher than the oldest
            const oldestPrice = prices[0];
            const mostRecentPrice = prices[prices.length - 1];

            if (greenInput) {
                greenInput.value = mostRecentPrice > oldestPrice;
            }
        }

        // Function to update the inputs for the current Bitcoin price digits
        async function updateBitcoinPriceDigits() {
            const priceDigits = await fetchCurrentBitcoinPrice(); // Fetch current Bitcoin price digits

            // Feed the individual price digits into the Rive inputs (btc_price_num_1 to btc_price_num_5)
            for (let i = 0; i < 5; i++) {
                if (btcPriceInputs[i]) {
                    btcPriceInputs[i].value = priceDigits[i] ? parseInt(priceDigits[i], 10) : -1; // Set price digit or -1 for missing digits
                }
            }
        }

        // Initialize Rive instance with device pixel ratio handling
        riveInstance = new rive.Rive({
            src: 'bitcoin_graph.riv', // Ensure this file name is correct
            canvas: document.getElementById('riveCanvas'),
            autoplay: true,
            artboard: 'Artboard', // Ensure this artboard name is correct
            stateMachines: 'State Machine 1', // Ensure this state machine name is correct
            useDevicePixelRatio: true, // Enable high-DPI scaling
            onLoad: () => {
                const canvas = document.getElementById('riveCanvas');
                const dpr = window.devicePixelRatio || 1;

                // Get the size of the canvas in CSS pixels
                const rect = canvas.getBoundingClientRect();

                // Set the canvas width and height attributes to match the displayed size times the device pixel ratio
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;

                // Now resize the Rive drawing surface to match the canvas size
                riveInstance.resizeDrawingSurfaceToCanvas();

                // Retrieve the state machine inputs
                const inputs = riveInstance.stateMachineInputs('State Machine 1');

                // Find the 24-hour price inputs, named "Number 0", "Number 1", ..., "Number 23"
                for (let i = 0; i < 24; i++) {
                    const input = inputs.find(input => input.name === `Number ${i}`);
                    if (input) {
                        priceInputs.push(input); // Store each input in an array
                    }
                }

                // Find the inputs for current Bitcoin price digits (btc_price_num_1 to btc_price_num_5)
                for (let i = 1; i <= 5; i++) {
                    const input = inputs.find(input => input.name === `btc_price_num_${i}`);
                    if (input) {
                        btcPriceInputs.push(input); // Store each input in an array
                    }
                }

                // Find the "GREEN" boolean input
                greenInput = inputs.find(input => input.name === 'GREEN');

                // Update the Rive inputs with historical Bitcoin prices and current price digits
                updateHistoricalPrices();
                updateBitcoinPriceDigits();

                // Set intervals to update the data periodically
                setInterval(updateHistoricalPrices, 3600000); // Update historical prices every hour
                setInterval(updateBitcoinPriceDigits, 60000);   // Update current price every minute
            }
        });
    </script>
</body>
</html>


